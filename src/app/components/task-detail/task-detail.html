<div class="task-detail-container" *ngIf="taskDetails">
  <!-- Header Section -->
  <div class="detail-header sticky-top">
    <div class="d-flex align-items-center justify-content-between mb-2">
      <div class="breadcrumb-container">
        <small class="text-muted">{{ taskDetails.id }}</small>
      </div>
      <div class="btn-group">
        <button type="button" class="btn-close" aria-label="Close" (click)="onClose()"></button>
      </div>
    </div>
    <h3 class="m-0">{{ taskDetails.title }}</h3>
  </div>

  <!-- Main Content -->
  <div class="detail-content">
    <!-- Details Section -->
    <div class="detail-section mb-4">
      <h5 class="section-title mb-3">Details</h5>
      <div class="row">
        <div class="col-md-6">
          <div class="detail-item mb-2">
            <span class="detail-label">Status:</span>
            <span class="detail-value">
              <ng-container *ngIf="!editingStatus; else statusEdit">
                <span class="badge bg-primary">{{ taskDetails.status | statusLabel }}</span>
                <button class="btn btn-sm btn-link p-0 ms-2" (click)="startEditStatus()">
                  <i class="fas fa-edit"></i>
                </button>
              </ng-container>
              <ng-template #statusEdit>
                <select class="form-select form-select-sm" [(ngModel)]="editingStatusValue" style="width: auto;">
                  <option value="todo">To Do</option>
                  <option value="in_progress">In Progress</option>
                  <option value="code_review">Code Review</option>
                  <option value="test_ready">Test Ready</option>
                  <option value="finished">Finished</option>
                </select>
                <button class="btn btn-sm btn-success ms-2" (click)="saveStatus()">
                  <i class="fas fa-check"></i>
                </button>
                <button class="btn btn-sm btn-secondary ms-1" (click)="cancelEditStatus()">
                  <i class="fas fa-times"></i>
                </button>
              </ng-template>
            </span>
          </div>
          <div class="detail-item mb-2">
            <span class="detail-label">Priority:</span>
            <span class="detail-value">
              <ng-container *ngIf="!editingPriority; else priorityEdit">
                <div class="priority-badge-detail">
                  <span class="badge" [ngClass]="getPriorityBadgeClass(taskDetails.priority)">
                    <i class="bi" [ngClass]="getPriorityIcon(taskDetails.priority)"></i>
                    {{ taskDetails.priority | titlecase }}
                  </span>
                  <button class="btn btn-sm btn-link p-0 ms-2" (click)="startEditPriority()">
                    <i class="bi bi-pencil"></i>
                  </button>
                </div>
              </ng-container>
              <ng-template #priorityEdit>
                <select class="form-select form-select-sm" [(ngModel)]="editingPriorityValue" style="width: auto;">
                  <option value="low">Low</option>
                  <option value="medium">Medium</option>
                  <option value="high">High</option>
                  <option value="urgent">Urgent</option>
                </select>
                <button class="btn btn-sm btn-success ms-2" (click)="savePriority()">
                  <i class="fas fa-check"></i>
                </button>
                <button class="btn btn-sm btn-secondary ms-1" (click)="cancelEditPriority()">
                  <i class="fas fa-times"></i>
                </button>
              </ng-template>
            </span>
          </div>
          <div class="detail-item mb-2">
            <span class="detail-label">Title:</span>
            <span class="detail-value">
              <ng-container *ngIf="!editingTitle; else titleEdit">
                {{ taskDetails.title }}
                <button class="btn btn-sm btn-link p-0 ms-2" (click)="startEditTitle()">
                  <i class="fas fa-edit"></i>
                </button>
              </ng-container>
              <ng-template #titleEdit>
                <input type="text" class="form-control form-control-sm" [(ngModel)]="editingTitleValue" style="width: auto;">
                <button class="btn btn-sm btn-success ms-2" (click)="saveTitle()">
                  <i class="fas fa-check"></i>
                </button>
                <button class="btn btn-sm btn-secondary ms-1" (click)="cancelEditTitle()">
                  <i class="fas fa-times"></i>
                </button>
              </ng-template>
            </span>
          </div>
          <div class="detail-item mb-2">
            <span class="detail-label">Story Points:</span>
            <span class="detail-value">
              <ng-container *ngIf="!editingPoints; else pointsEdit">
                {{ taskDetails.points || 0 }}
                <button class="btn btn-sm btn-link p-0 ms-2" (click)="startEditPoints()">
                  <i class="fas fa-edit"></i>
                </button>
              </ng-container>
              <ng-template #pointsEdit>
                <input type="number" class="form-control form-control-sm" [(ngModel)]="editingPointsValue" style="width: 80px;">
                <button class="btn btn-sm btn-success ms-2" (click)="savePoints()">
                  <i class="fas fa-check"></i>
                </button>
                <button class="btn btn-sm btn-secondary ms-1" (click)="cancelEditPoints()">
                  <i class="fas fa-times"></i>
                </button>
              </ng-template>
            </span>
          </div>
        </div>
        <div class="col-md-6">
          <div class="detail-item mb-2">
            <span class="detail-label">Description:</span>
            <span class="detail-value">
              <ng-container *ngIf="!editingDescription; else descriptionEdit">
                {{ taskDetails.description || 'No description' }}
                <button class="btn btn-sm btn-link p-0 ms-2" (click)="startEditDescription()">
                  <i class="fas fa-edit"></i>
                </button>
              </ng-container>
              <ng-template #descriptionEdit>
                <textarea class="form-control form-control-sm" [(ngModel)]="editingDescriptionValue" rows="3" style="width: auto;"></textarea>
                <div class="mt-2">
                  <button class="btn btn-sm btn-success me-1" (click)="saveDescription()">
                    <i class="fas fa-check"></i> Save
                  </button>
                  <button class="btn btn-sm btn-secondary" (click)="cancelEditDescription()">
                    <i class="fas fa-times"></i> Cancel
                  </button>
                </div>
              </ng-template>
            </span>
          </div>
          <div class="detail-item mb-2">
            <span class="detail-label">Due Date:</span>
            <span class="detail-value">
              <ng-container *ngIf="!editingDueDate; else dueDateEdit">
                {{ taskDetails.due_date || 'No due date' }}
                <button class="btn btn-sm btn-link p-0 ms-2" (click)="startEditDueDate()">
                  <i class="fas fa-edit"></i>
                </button>
              </ng-container>
              <ng-template #dueDateEdit>
                <input type="date" class="form-control form-control-sm" [(ngModel)]="editingDueDateValue" style="width: auto;">
                <button class="btn btn-sm btn-success ms-2" (click)="saveDueDate()">
                  <i class="fas fa-check"></i>
                </button>
                <button class="btn btn-sm btn-secondary ms-1" (click)="cancelEditDueDate()">
                  <i class="fas fa-times"></i>
                </button>
              </ng-template>
            </span>
          </div>
        </div>
      </div>
    </div>

    <!-- People Section -->
    <div class="detail-section mb-4">
      <h5 class="section-title mb-3">People</h5>
      <div class="row">
        <div class="col-md-6">
          <div class="detail-item mb-2">
            <span class="detail-label">QA:</span>
            <span class="detail-value text-muted">None</span>
          </div>
          <div class="detail-item mb-2">
            <span class="detail-label">Reporter:</span>
            <span class="detail-value">John Smith</span>
          </div>
        </div>
        <div class="col-md-6">
          <div class="detail-item mb-2">
            <span class="detail-label">Assignee:</span>
            <span class="detail-value">
              <ng-container *ngIf="assigneeUser; else noAssignee">
                <div class="d-flex align-items-center">
                  <img [src]="assigneeUser?.avatarUrl" (error)="onAvatarError($event)" 
                       width="24" height="24" class="rounded-circle me-2" alt="avatar" />
                  <span>{{ assigneeUser?.firstName }} {{ assigneeUser?.lastName }}</span>
                </div>
                <button class="btn btn-sm btn-link p-0 mt-1" (click)="assignToMe()">Assign to me</button>
              </ng-container>
              <ng-template #noAssignee>
                <span class="text-muted">Unassigned</span>
                <button class="btn btn-sm btn-link p-0 ms-2" (click)="assignToMe()">Assign to me</button>
              </ng-template>
            </span>
          </div>
        </div>
      </div>
    </div>

    <!-- Dates Section -->
    <div class="detail-section mb-4">
      <h5 class="section-title mb-3">Dates</h5>
      <div class="row">
        <div class="col-md-6">
          <div class="detail-item mb-2">
            <span class="detail-label">Due Date:</span>
            <span class="detail-value" *ngIf="taskDetails.due_date; else noDueDate">
              {{ taskDetails.due_date | date:'dd/MMM/yy' }}
              <span class="text-danger ms-2" *ngIf="isTaskOverdue(taskDetails.due_date, taskDetails.status)">
                <i class="fas fa-exclamation-triangle"></i> Overdue
              </span>
            </span>
            <ng-template #noDueDate>
              <span class="text-muted">No due date</span>
            </ng-template>
          </div>
          <div class="detail-item mb-2">
            <span class="detail-label">Created:</span>
            <span class="detail-value">{{ taskDetails.created_at | date:'dd/MMM/yy h:mm a' }}</span>
          </div>
        </div>
        <div class="col-md-6">
          <div class="detail-item mb-2">
            <span class="detail-label">Last Updated:</span>
            <span class="detail-value">{{ taskDetails.updated_at | date:'dd/MMM/yy h:mm a' }}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Description Section -->
    <div class="detail-section mb-4" *ngIf="taskDetails.description">
      <h5 class="section-title mb-3">Description</h5>
      <div class="description-content">
        <p>{{ taskDetails.description }}</p>
      </div>
    </div>

    <!-- Comments Section -->
    <div class="detail-section mb-4">
      <h5 class="section-title mb-3">Comments</h5>
      <div class="comment-input-container">
        <div class="form-group">
          <textarea class="form-control" rows="3" placeholder="Add a comment..."></textarea>
        </div>
        <div class="mt-2">
          <small class="text-muted">CliPro tip: press m to comment</small>
        </div>
      </div>
    </div>

    <!-- Actions Section -->
    <div class="detail-section">
      <div class="d-flex gap-2">
      </div>
    </div>
  </div>
</div>

<task-form
  [taskToEdit]="taskDetails"
  (taskUpdated)="onTaskUpdated($event)"
></task-form>

<div *ngIf="!taskDetails">
  <div class="text-center p-4">
    <i class="fas fa-exclamation-triangle text-warning mb-3" style="font-size: 2rem;"></i>
    <p class="text-muted">Task details could not be found.</p>
  </div>
</div>
