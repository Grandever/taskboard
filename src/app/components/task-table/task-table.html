<!-- task-table.html -->
<div class="card p-3">
  <!-- Data Generator Component -->
  <app-data-generator></app-data-generator>
  <!-- Skeleton loading -->
     <app-skeleton 
     *ngIf="loading" 
     [rows]="5"
     [columns]="[
       { width: '20%' },
       { width: '15%' },
       { width: '15%' },
       { width: '20%' },
       { width: '20%' },
       { width: '10%' }
     ]">
   </app-skeleton>

     <!-- Actual table -->
   <table *ngIf="!loading" class="table table-bordered table-striped custom-table">
     <thead>
     <tr class="table-header">
              <th style="width:20%; cursor:pointer" (click)="toggleSort('title')" title="Sort by Title">
         <div class="header-content">
                       <i class="bi bi-house me-2"></i>
           <span class="header-text">TITLE</span>
                       <div class="sort-icons">
              <ng-container *ngIf="sortBy === 'title'; else titleNeutral">
                <i *ngIf="sortDir === 'asc'" class="bi bi-sort-up"></i>
                <i *ngIf="sortDir === 'desc'" class="bi bi-sort-down"></i>
              </ng-container>
              <ng-template #titleNeutral>
                <i class="bi bi-sort"></i>
              </ng-template>
            </div>
         </div>
       </th>
              <th style="width:15%; cursor:pointer" (click)="toggleSort('status')" title="Sort by Status">
         <div class="header-content">
                       <i class="bi bi-building me-2"></i>
           <span class="header-text">STATUS</span>
                       <div class="sort-icons">
              <ng-container *ngIf="sortBy === 'status'; else statusNeutral">
                <i *ngIf="sortDir === 'asc'" class="bi bi-sort-up"></i>
                <i *ngIf="sortDir === 'desc'" class="bi bi-sort-down"></i>
              </ng-container>
              <ng-template #statusNeutral>
                <i class="bi bi-sort"></i>
              </ng-template>
            </div>
         </div>
       </th>
              <th style="width:15%; cursor:pointer" (click)="toggleSort('priority')" title="Sort by Priority">
         <div class="header-content">
                       <i class="bi bi-eye me-2"></i>
           <span class="header-text">PRIORITY</span>
                       <div class="sort-icons">
              <ng-container *ngIf="sortBy === 'priority'; else priorityNeutral">
                <i *ngIf="sortDir === 'asc'" class="bi bi-sort-up"></i>
                <i *ngIf="sortDir === 'desc'" class="bi bi-sort-down"></i>
              </ng-container>
              <ng-template #priorityNeutral>
                <i class="bi bi-sort"></i>
              </ng-template>
            </div>
         </div>
       </th>
              <th style="width:25%; cursor:pointer" (click)="toggleSort('updated_at')" title="Sort by Updated At">
         <div class="header-content">
                       <i class="bi bi-envelope me-2"></i>
           <span class="header-text">UPDATED AT</span>
                       <div class="sort-icons">
              <ng-container *ngIf="sortBy === 'updated_at'; else updatedNeutral">
                <i *ngIf="sortDir === 'asc'" class="bi bi-sort-up"></i>
                <i *ngIf="sortDir === 'desc'" class="bi bi-sort-down"></i>
              </ng-container>
              <ng-template #updatedNeutral>
                <i class="bi bi-sort"></i>
              </ng-template>
            </div>
         </div>
       </th>
              <th style="width:15%">
         <div class="header-content">
                       <i class="bi bi-calendar me-2"></i>
           <span class="header-text">DUE DATE</span>
         </div>
       </th>
               <th style="width:20%">
          <div class="header-content">
                        <i class="bi bi-geo-alt me-2"></i>
            <span class="header-text">ASSIGNEE</span>
          </div>
        </th>
        <th style="width:10%">
          <div class="header-content">
            <i class="bi bi-gear me-2"></i>
            <span class="header-text">ACTIONS</span>
          </div>
        </th>
     </tr>
     <tr class="filter-row">
       <th>
         <div class="filter-container">
           <input class="form-control form-control-sm filter-input" placeholder="Search title" [(ngModel)]="filters.title" (ngModelChange)="onFiltersChanged()" />
           <i class="bi bi-funnel filter-icon"></i>
         </div>
       </th>
       <th>
         <div class="filter-container">
           <select class="form-select form-select-sm filter-input" [(ngModel)]="filters.status" (ngModelChange)="onFiltersChanged()">
             <option [ngValue]="undefined">All</option>
             <option *ngFor="let s of statusOptions" [ngValue]="s">{{ s }}</option>
           </select>
           <i class="bi bi-chevron-down filter-icon"></i>
         </div>
       </th>
       <th>
         <div class="filter-container">
           <select class="form-select form-select-sm filter-input" [(ngModel)]="filters.priority" (ngModelChange)="onFiltersChanged()">
             <option [ngValue]="undefined">All</option>
             <option *ngFor="let p of priorityOptions" [ngValue]="p">{{ p }}</option>
           </select>
           <i class="bi bi-chevron-down filter-icon"></i>
         </div>
       </th>
       <th>
         <div class="filter-container">
           <input class="form-control form-control-sm filter-input" placeholder="Search updated" [(ngModel)]="filters.updated_at" (ngModelChange)="onFiltersChanged()" />
           <i class="bi bi-funnel filter-icon"></i>
         </div>
       </th>
       <th>
         <div class="filter-container">
           <input class="form-control form-control-sm filter-input" type="date" [(ngModel)]="filters.due_date" (ngModelChange)="onFiltersChanged()" />
           <i class="bi bi-calendar filter-icon"></i>
         </div>
       </th>
               <th>
          <div class="filter-container">
            <select class="form-select form-select-sm filter-input" [(ngModel)]="filters.assignee" (ngModelChange)="onFiltersChanged()">
              <option [ngValue]="undefined">All</option>
              <option *ngFor="let u of users" [ngValue]="u.id">{{ u.firstName }} {{ u.lastName }}</option>
            </select>
            <i class="bi bi-chevron-down filter-icon"></i>
          </div>
        </th>
        <th>
          <!-- No filter for actions column -->
        </th>
     </tr>
     </thead>
    <tbody>
         <tr *ngFor="let task of pagedTasks" 
         (click)="onRowClick(task, $event)"
         (keydown)="onRowKeydown($event, task)"
         [class.selected-row]="selectedTask?.id === task.id"
         tabindex="0"
         class="table-row-clickable">
      <td>{{ task.title }}</td>
      <td>{{ task.status | statusLabel }}</td>
      <td>
        <span [ngClass]="getPriorityBadgeClass(task.priority)">{{ task.priority }}</span>
      </td>
      <td>{{ task.updated_at | date:'yyyy-MM-dd HH:mm' }}</td>
      <td>
        <div class="d-flex flex-column">
          <span *ngIf="task.due_date">{{ task.due_date | date:'yyyy-MM-dd' }}</span>
          <span *ngIf="!task.due_date" class="text-muted">No due date</span>
                     <span *ngIf="task.due_date && isTaskOverdue(task.due_date, task.status)" 
                 class="badge bg-danger text-white mt-1" style="font-size: 0.7em;">
             Overdue
           </span>
        </div>
      </td>
             <td>
         <div class="d-flex align-items-center">
           <ng-container *ngIf="getAssignee(task) as a; else unassignedTpl">
             <span>j_{{ a.username.toLowerCase() }}</span>
           </ng-container>
           <ng-template #unassignedTpl>
             <span class="text-muted">Unassigned</span>
           </ng-template>
         </div>
       </td>
       <td>
         <div class="d-flex gap-1 justify-content-center">
           <button class="btn btn-sm btn-outline-primary" 
                   (click)="viewTaskDetails(task)" 
                   title="View Details">
             <i class="bi bi-eye"></i>
           </button>
           <button class="btn btn-sm btn-outline-warning" 
                   (click)="editTask(task)" 
                   title="Edit Task">
             <i class="bi bi-pencil"></i>
           </button>
           <button class="btn btn-sm btn-outline-danger" 
                   (click)="deleteTask(task)" 
                   title="Delete Task">
             <i class="bi bi-trash"></i>
           </button>
         </div>
       </td>
     </tr>
   
    </tbody>
     </table>
      <ng-container *ngIf="!loading && pagedTasks.length === 0">
     <div class="d-flex flex-column align-items-center justify-content-center text-muted py-5" style="min-height: 180px;">
       <i class="bi bi-inbox fs-1 mb-3"></i>
       <div class="fs-5">No Records Found</div>
     </div>
   </ng-container>
   
       <!-- Paginator always at bottom -->
    <app-paginator
      [currentPage]="currentPage"
      [totalItems]="totalItems"
      [itemsPerPage]="itemsPerPage"
      (pageChange)="onPageChange($event)"
      (pageSizeChange)="onPageSizeChange($event)"
         ></app-paginator>

  <!-- Task Form Modal -->
  <task-form 
    (taskAdded)="onTaskAdded($event)"
    (taskUpdated)="onTaskUpdated($event)">
  </task-form>


</div>
